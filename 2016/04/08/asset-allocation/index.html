<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Dynamic asset allocation - a Monte Carlo approach | Yibing Xie</title>
  <meta name="author" content="Yibing Xie">
  
  <meta name="description" content="This artical provides a possible python implementation of the paper by Riccardo Cesari and David Cremonini(2003).">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Dynamic asset allocation - a Monte Carlo approach"/>
  <meta property="og:site_name" content="Yibing Xie"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Yibing Xie" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-76123207-1', 'auto');
	ga('send', 'pageview');

</script>


</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Yibing Xie</a></h1>
  <h2><a href="/">A place with no name..</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2016-04-09T02:21:51.000Z"><a href="/2016/04/08/asset-allocation/">2016-04-08</a></time>
      
      
  
    <h1 class="title">Dynamic asset allocation - a Monte Carlo approach</h1>
  

    </header>
    <div class="entry">
      
        <p>This artical provides a possible python implementation of <a href="http://www.sciencedirect.com/science/article/pii/S0165188902000520" target="_blank" rel="external">the paper</a> by <em>Riccardo Cesari</em> and <em>David Cremonini</em>(2003).<br><a id="more"></a></p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Just like the original paper, this article makes an extensive simulation comparison of popular dynamic strategies of asset allocation. For each strategy, <strong>Sharpe ratio</strong>, <strong>Sortino ratio</strong>, <strong>risk-adjusted return (RaR)</strong>, etc. are calculated for evaluation. The strategies are compared in different market situations (bull, bear, no-trend markets) and with different market volatility, taking into account transaction costs and discrete rebalancing of portfolios. Finally, I verified the author’s conclusion that constant proportion strategy is dominant in bear and no-trend markets. Moreover, these results are independent of the volatility level and the risk-adjusted measure adopted. Hopefully this will give some implication to the investors.</p>
<h2 id="Strategies"><a href="#Strategies" class="headerlink" title="Strategies"></a>Strategies</h2><ol>
<li><strong>Buy and Hold:</strong> simplest strategy, no need for explanation.</li>
<li><strong>Constant Mix:</strong> keep the market value proportion of the risky assets and riskless assets constant.</li>
<li><strong><a href="http://www.investopedia.com/terms/c/cppi.asp" target="_blank" rel="external">Constant Proportion Portfolio Insurance</a>:</strong><br>Suppose $E_t$ is the value of the risky assets at time $t$, and $A_t$ is the total value of the portfolio, then the proportion invested in risky assets is defined as<br>\begin{equation}<br>E_t = \begin{cases}<br> \text{min} \left\{A_t, m\left(A_t - F_t \right) \right \}, &amp; \text{if $A_t &gt; F_t$} \\<br> 0, &amp; \text{if $A_t \leq F_t$}<br>\end{cases}<br>\end{equation}<br>where $F_t$ is the floor at time $t$. In this case the floor is defined to be $F_t = Ke^{-r\left(T - t \right )}$, where $K$ is the floor at time $T$. Moreover, we set $m = 2$.</li>
<li><p><strong>Option based strategies:</strong><br>The idea behind the option based strategies relies on the fact that buying a put option with strike K and maturity T plus one stock can guarantee the floor K and any upside increase realized at maturity T. Based on the initial balance constraint the strategies differ in the following way:</p>
<ul>
<li><p>BCDT<br>$$g\left[S_0 + \text{Put}\left(S_0, K \right ) \right ] + B_0 = A_0 $$<br>where $B_0$ is the initial amount of the risk-free asset(cash).<br>Using the put funtion, the balance constraint is<br>$$ gS_0N\left(d_1\left(0 \right ) \right) + gKN\left(-d_2\left(0 \right ) \right)e^{-rT} + B_0 = A_0 $$<br>At maturity $T$, if the risky asset is below the floor, i.e. $    S_T &lt; K$, the mininum value must beguaranteed:<br>$$ gK + B_0e^{rT} = K $$<br>From these conditions and the put-call parity we obtain the value for g, which is<br>$$ B_0 = \left(1 - g \right )Ke^{-rT} \\<br>g = \frac{A_0 - Ke^{-rT}}{\text{Call}_0} $$<br>Therefore the initial capital invested in stock is $gS_0N\left(d_1\left(0 \right ) \right)$. At any time $t$, the value of of capital invested in stock is $gS_tN\left(d_1\left(t \right ) \right)$.<br>At Maturity:<br>\begin{equation}<br>A_T = \begin{cases}<br>gS_T + B_T = gS_T + \left(1 - g \right )K, &amp; \text{if $S_T &gt; K$} \\<br>gS_T + B_T = K, &amp; \text{if $S_T &lt; K$}<br>\end{cases}<br>\end{equation}</p>
</li>
<li><p>NL<br>Find the strike $H$ and the multiplier $h$ such that<br>$$ h\left[S_0 + \text{Put}\left(S_0, H \right ) \right ] = A_0 \\<br>hH = K $$<br>Defining $S_0^0 = hS_0$ we have<br>$$ A_0 = S_0^0 + \text{Put}\left(S_0^0, K \right ) = \text{Call}\left(S_0^0, K \right ) + Ke^{-rT} $$<br>And the value $S_0^0$ can be obtained using <a href="https://en.wikipedia.org/wiki/Newton%27s_method" target="_blank" rel="external">Newton-Raphson method</a>, given $A_0$ and $K$.<br>The amount invested in stock si therefore $N\left(d_1^0 \right)S_0^0 = N\left(d_1^0\left(0 \right) \right)hS_0$. At any time $t$, the value of of capital invested in stock is $N\left(d_1^0\left(t \right) \right)hS_t$.<br>At maturity:<br>\begin{equation}<br>A_T = \begin{cases}<br>S_T^0 = hS_T, &amp; \text{if $S_T^0 &gt; K$} \\<br>K, &amp; \text{if $S_T^0 &lt; K$}<br>\end{cases}<br>\end{equation}</p>
</li>
<li><p>PS<br>$$ n\text{Call}\left(S_0, K \right ) + B_0 = A_0 $$<br>Imposing the constraint of a sach at maturity equal to the floor $K$ if the calls will expire out of the money will give equivalent solution to BCDT as a result of put-call parity. On the other hand, imposing a liquidity in $T$ equal to the total delivery payment if the calls will expire in the money we have<br>$$ n\left(S_T - K \right ) + B_0e^{rT} = nS_T $$<br>which yields<br>$$ B_0 = nKe^{-rT} \\<br>n = \frac{A_0}{\text{Call}_0 + Ke^{-rT}} = \frac{A_0}{S_0 + \text{Put}_0} $$<br>From the call function we obtain<br>$$ nS_0N\left(d_1\left(0 \right ) \right) + nKN\left(-d_2\left(0 \right ) \right)e^{-rT} = A_0 $$<br>Therefore the initial capital invested in stock is $nS_0N\left(d_1\left(0 \right ) \right)$. At any time $t$, the value of of capital invested in stock is $nS_tN\left(d_1\left(t \right ) \right)$.<br>At maturity:<br>\begin{equation}<br>A_T = \begin{cases}<br>nS_T, &amp; \text{if $S_T^0 &gt; K$} \\<br>nK, &amp; \text{if $S_T^0 &lt; K$}<br>\end{cases}<br>\end{equation}</p>
</li>
</ul>
</li>
<li><p><strong>Moving Average Strategy:</strong> if a short memory moving average crosses a long memory moving average from below the trader receives a “buy” signal; if the former crosses the latter from above the signal is to “sell”. </p>
<p>In our simulations the long memory is a <strong>30 week moving average</strong> and the short memory is either the <strong>current price (MA)</strong> or a <strong>10 week moving average (MA2)</strong>.</p>
</li>
</ol>
<h2 id="Preliminary-Test"><a href="#Preliminary-Test" class="headerlink" title="Preliminary Test"></a>Preliminary Test</h2><p>Random number generation is a crucial step in our simulation. To implement the Monte-Carlo simulation properly, two important assumptions must be guaranteed, which is the normality and independence of the time series data. To justify these assumptions, the normality test and independence test must be carried out with actual market data in order to verify if the simulation setup can be approximately compared with the data generating mechanism of real situations.</p>
<p>The statistical hypothesis tests chosen for testing normality and independence are the <a href="https://en.wikipedia.org/wiki/Shapiro%E2%80%93Wilk_test" target="_blank" rel="external"><strong>Shapiro-Wilk test</strong></a> and the <a href="https://en.wikipedia.org/wiki/Ljung%E2%80%93Box_test" target="_blank" rel="external"><strong>Ljung-Box test</strong></a>, respectively. The Shapiro–Wilk test utilizes the null hypothesis principle to check whether a sample came from a normally distributed population while the Ljung-Box test checks whether any of a group of autocorrelations of a time series are different from zero. The details of these two tests are omitted, however, what is important to know is that the <strong>null hypothesis</strong> of the Sharpiro-Wilk test is that the population <strong>is normally distributed</strong> while the <strong>null hypothesis</strong> of the Ljung-Box test is that the population <strong>is independently distributed</strong>. </p>
<p>The price series I choose is MSCI World index, the same as the author did. Weekly prices and log-returns are depicted in Fig. 1 and Fig 2, respectively.<br><img src="../../../../image/asset-allocation/1.jpg" alt="Fig. 1  Weekly prices of MSCI World"></p>
<p><img src="../../../../image/asset-allocation/2.jpg" alt="Fig. 2  Weekly log-return of MSCI World"></p>
<p>In the period January 1997 to July 1999 the Shapiro –Wilk test shows the normality of weekly returns at high significance levels for the World index.</p>
<p><strong>Table 1</strong>  Shapiro –Wilk test</p>
<table>
<thead>
<tr>
<th style="text-align:center">Test statistic</th>
<th style="text-align:center">p-value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0.9919</td>
<td style="text-align:center">0. 6412</td>
</tr>
</tbody>
</table>
<p>Moreover, the Ljung–Box test of autocorrelation shows a large degree of randomness in the weekly returns up to 24 lags (120 working days). Detail of the test and the plot of autocorrelation function is shown in Table 2 and Fig. 3.</p>
<p><strong>Table 2</strong>  Ljung–Box test</p>
<table>
<thead>
<tr>
<th style="text-align:center">Lags</th>
<th style="text-align:center">p-value</th>
<th style="text-align:center">Lags</th>
<th style="text-align:center">p-value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">0.5913</td>
<td style="text-align:center">13</td>
<td style="text-align:center">0.2645</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">0.1708</td>
<td style="text-align:center">14</td>
<td style="text-align:center">0.1614</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">0.3098</td>
<td style="text-align:center">15</td>
<td style="text-align:center">0.1938</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">0.4572</td>
<td style="text-align:center">16</td>
<td style="text-align:center">0.2400</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">0.5926</td>
<td style="text-align:center">17</td>
<td style="text-align:center">0.2906</td>
</tr>
<tr>
<td style="text-align:center">6</td>
<td style="text-align:center">0.6794</td>
<td style="text-align:center">18</td>
<td style="text-align:center">0.3460</td>
</tr>
<tr>
<td style="text-align:center">7</td>
<td style="text-align:center">0.1589</td>
<td style="text-align:center">19</td>
<td style="text-align:center">0.4072</td>
</tr>
<tr>
<td style="text-align:center">8</td>
<td style="text-align:center">0.2276</td>
<td style="text-align:center">20</td>
<td style="text-align:center">0.4678</td>
</tr>
<tr>
<td style="text-align:center">9</td>
<td style="text-align:center">0.2710</td>
<td style="text-align:center">21</td>
<td style="text-align:center">0.4514</td>
</tr>
<tr>
<td style="text-align:center">10</td>
<td style="text-align:center">0.3450</td>
<td style="text-align:center">22</td>
<td style="text-align:center">0.5096</td>
</tr>
<tr>
<td style="text-align:center">11</td>
<td style="text-align:center">0.4049</td>
<td style="text-align:center">23</td>
<td style="text-align:center">0.5103</td>
</tr>
<tr>
<td style="text-align:center">12</td>
<td style="text-align:center">0.2065</td>
<td style="text-align:center">24</td>
<td style="text-align:center">0.5661</td>
</tr>
</tbody>
</table>
<p><img src="../../../../image/asset-allocation/3.jpg" alt="Fig. 3  Autocorrelation Plot"><br>Overall, we are confident in assuming normality and independence in our simulation exercise.</p>
<h2 id="Simulation-Process"><a href="#Simulation-Process" class="headerlink" title="Simulation Process"></a>Simulation Process</h2><ol>
<li>Annual market return and volatility is drawn from uniform distribution in order to cover as many market scenarios as possible.<br>$$ \mu \sim U\left(-0.3, 0.3 \right) \\<br>\sigma \sim U\left(0.1, 0.3 \right) $$</li>
<li>Generate 360 normally distributed weekly returns from $N\left(\frac{\mu}{52}, \frac{\sigma}{\sqrt{52}} \right)$. Also assume $r = 0.03$, $K = S_0 = A_0$.</li>
<li>Transaction cost are taken into account in two ways: in the form of a cost proportional to the value traded $c = 0.3%$ and as a correction to the option volatility according to Leland (1985) formula:<br>$$ \sigma_{adj}^2 = \sigma^2\left(1 + c\frac{\sqrt{2/\pi}}{\sigma\sqrt{\Delta t}} \right ) $$</li>
<li>The 8 strategies are implemented over $T = 260$ rolling window and the first 100 data is used to estimate volatility for the option based strategies.</li>
<li>Repeat step 1-4 for 10000 times and record results for each simulation.</li>
</ol>
<h2 id="Results"><a href="#Results" class="headerlink" title="Results"></a>Results</h2><p>A preliminary historical simulation using the MSCI World indexes for the period between 1997 and 1999 has been run with weekly rebalance. The results is given in Fig. 4.<br><img src="../../../../image/asset-allocation/4.jpg" alt="Fig. 4  Risk and return of trading strategies"></p>
<p>The historical simulation shows that PS and NL strategies reach higher returns but also show greater standard deviations. CPL strategy, vice versa, has low returns and low risk. With the exception of technical rules, the fundamental law of finance seems to be confirmed by the considered strategies applied to the World equity market.</p>
<p>Historical simulations, however, do not allow us to properly compare the considered strategies and test the significance of the performance differences. For this purpose we have run the Monte Carlo simulation process described in Section 3. Summary statistics for the nine strategies and the stock market index are reported in Figs. 5–8.</p>
<p>In terms of identifying different markets, devide the market return into three categories, namely $\left(-0.3, -0.05 \right )$, $\left(-0.05, 0.05 \right )$ and $\left(0.05, 0.3 \right )$. The performances of each strategy under different markets trends are summarized as follows:<br><img src="../../../../image/asset-allocation/all.png" alt="Fig. 5  Performance in All Markets"></p>
<p><img src="../../../../image/asset-allocation/bear.png" alt="Fig. 6  Performance in Bear Markets"></p>
<p><img src="../../../../image/asset-allocation/notrend.png" alt="Fig. 7  Performance in No Trend Markets"></p>
<p><img src="../../../../image/asset-allocation/bull.png" alt="Fig. 8  Performance in Bull Markets"></p>
<p>Also, divide the market volatility into $\left(0.1, 0.15 \right )$, $\left(0.15, 0.25 \right )$ and $\left(0.25, 0.3 \right )$ to denote low volatility, medium volatility and high volatility, respectively. Comparing the performances under different combinations of market scenarios gives</p>
<p><strong>Table 3</strong>  Best strategy in Monte Carlo simulations</p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">Low Volatility</th>
<th style="text-align:center">Medium Volatility</th>
<th style="text-align:center">High Volatility</th>
<th style="text-align:center">All Scenarios</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><em>Sortino</em></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">Bear Market</td>
<td style="text-align:center">CPPI, NL, BCDT, MA2</td>
<td style="text-align:center">CPPI</td>
<td style="text-align:center">CPPI</td>
<td style="text-align:center">CPPI</td>
</tr>
<tr>
<td style="text-align:center">No-trend Market</td>
<td style="text-align:center">CPPI</td>
<td style="text-align:center">CPPI</td>
<td style="text-align:center">CM</td>
<td style="text-align:center">CM, CPPI</td>
</tr>
<tr>
<td style="text-align:center">Bull Market</td>
<td style="text-align:center">CM, BH</td>
<td style="text-align:center">CM</td>
<td style="text-align:center">CM</td>
<td style="text-align:center">CM</td>
</tr>
<tr>
<td style="text-align:center">All Market</td>
<td style="text-align:center">BCDT, CPPI, NL, MA2</td>
<td style="text-align:center">BCDT, CPPI</td>
<td style="text-align:center">BCDT, CPPI</td>
<td style="text-align:center">BCDT, CPPI</td>
</tr>
<tr>
<td style="text-align:center"><em>RaR</em></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td></td>
</tr>
<tr>
<td style="text-align:center">Bear Market</td>
<td style="text-align:center">CPPI</td>
<td style="text-align:center">CPPI</td>
<td style="text-align:center">CPPI, BCDT</td>
<td style="text-align:center">CPPI</td>
</tr>
<tr>
<td style="text-align:center">No-trend Market</td>
<td style="text-align:center">CPPI</td>
<td style="text-align:center">CPPI</td>
<td style="text-align:center">CPPI</td>
<td style="text-align:center">CPPI</td>
</tr>
<tr>
<td style="text-align:center">Bull Market</td>
<td style="text-align:center">CM</td>
<td style="text-align:center">CM</td>
<td style="text-align:center">CM</td>
<td style="text-align:center">CM</td>
</tr>
<tr>
<td style="text-align:center">All Market</td>
<td style="text-align:center">BCDT, CPPI</td>
<td style="text-align:center">BCDT, CPPI</td>
<td style="text-align:center">BCDT, CPPI</td>
<td style="text-align:center">BCDT, CPPI</td>
</tr>
</tbody>
</table>
<p>The main findings, with weekly rebalance, are the following:</p>
<ol>
<li>in a bear market as well as in a market without trend CPPI strategies appear to be the best choice, both in terms of Sortino ratio and in terms of RaR. In the absence of trends but with high volatility CM strategy (benchmarking) is preferable, according to Sortino ratio. CM is also recommended in bull markets;</li>
<li>if the market phase is unknown (uniform prior probability for bear, no-trend and bull market) CPPI and BCDT are the best performing strategies;</li>
<li>the best strategy is almost independent of the volatility level prevailing in the market, at least in the considered range 10–30% suggested by the historical data. This is especially true using the RaR criterion;</li>
<li>in contrast with the historical simulation, in the Monte Carlo experiment the best strategy is largely independent of the adopted performance measure.</li>
</ol>
<p>Possible cumulative return curves are shown in Fig. 9 to Fig. 11.<br><img src="../../../../image/asset-allocation/bear_return.png" alt="Fig. 9  Possible Cumulative Return in Bear Markets"></p>
<p><img src="../../../../image/asset-allocation/notrend_return.png" alt="Fig. 10  Possible Cumulative Return in No Trend Markets"></p>
<p><img src="../../../../image/asset-allocation/bull_return.png" alt="Fig. 11  Possible Cumulative Return in Bull Markets"></p>
<h2 id="Extension"><a href="#Extension" class="headerlink" title="Extension"></a>Extension</h2><p>In the original paper, the author claims that CPPI is dominated in both bear and no trend markets while CM is preferable in the bull markets in terms of Sortino ratio, which we already verified. </p>
<p>Notice that in the replication process we stuck to the author’s assumption that the index prices follows a geometric Brownian motion, which implies the continuity nature of the index evolution. However, in the real markets, as shown in Fig. 12, there are often jumps during some periods, this may be due to some macroeconomic factors or financial crisis, which cannot be depicted by the original model. Therefore the original conclusions are not robust under real markets conditions.<br><img src="../../../../image/asset-allocation/5.png" alt="Fig. 12  Weekly Prices between 1999 and 2016"></p>
<p>It’s natural to incorporate the jump diffusion into the index price movement, and this is where the jump diffusion model, introduced by <strong>Robert C. Merton</strong>, comes into play. The jump diffusion model uses Poisson process to depict the jump events, and mathematically it can be written as follows<br>$$ S_t = S_0\text{exp}\left(\left(\mu - \frac{\sigma^2}{2} \right )t + \sigma W_t + \sum_{i=1}^{N_t}Y_it \right ) $$<br>where $N_t$ is a poisson process and $Y_i$ is the size of each jump on a annual basis.</p>
<p>Since we already confirmed the CM strategy is less attractive than CPPI under bear markets and preferable under bull markets, it’s tempting to investigate whether it’s still preferable to CPPI under bull markets with the existence of jumps. We don’t investigate the bear markets with jumps because of the insurance nature of the CPPI, which makes it immune to any kinds of downward trend. </p>
<p>Specifically, we let $\mu \sim U(0.3,0.5)$, $\sigma \sim U(0.1,0.3)$, $\lambda=2.5$, where $\lambda$ is the expected number of jumps during one year. Moreover, $Y_i \sim N(-4,1.5)$, which is the jump size on the annual basis. The simulation results are depicted in Fig. 13.<br><img src="../../../../image/asset-allocation/6.png" alt="Fig. 13  Bull Markets with Jumps"></p>
<p>Remember in the previous plot, CM strategy outperformed CPPI in the bull market with respect to every performance measure. However, after incorporating the effect of the jump diffusion, the performance of CM strategy is almost identical to the performance of CPPI as shown above except that the Sortino ratio of CM is still higher than CPPI by a small amount. Therefore we can conclude that CPPI strategy is also a relatively robust strategy under bull markets for risk-averse investors. </p>
<p>Possible cumulative return curves of different strategies are shown in Fig. 14 and 15.<br><img src="../../../../image/asset-allocation/bull_with_jump1.png" alt="Fig. 14  Possible Cumulative Return in Bull Markets with Jumps"></p>
<p><img src="../../../../image/asset-allocation/bull_with_jump2.png" alt="Fig. 15  Possible Cumulative Return in Bull Markets with Jumps"></p>
<h2 id="Conclusions"><a href="#Conclusions" class="headerlink" title="Conclusions"></a>Conclusions</h2><p>The results show a dominant role of constant proportion strategy (CPPI) in bear, no-trend markets and possibly bull markets for risk-averse investors and a preference for a constant mix strategy (CM) in bull markets. In the case of total ignorance about the market phase, CPPI and BCDT are the best strategies. Moreover, these results are independent of the volatility prevailing in the market. </p>
<h2 id="Python-Implementation"><a href="#Python-Implementation" class="headerlink" title="Python Implementation"></a>Python Implementation</h2><p>The implementation is based on my own <a href="https://github.com/xybhust/asset_allocation" target="_blank" rel="external">back-testing platform</a>. Core parts of the the Monte Carlo routine is as follows:<br><strong> Backtest module:</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pprint</span><br><span class="line"><span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> cPickle</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> pandas_datareader.data <span class="keyword">as</span> web</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> data_handler <span class="keyword">import</span> YahooDataHandler, MonteCarloDataHandler, CSVDataHandler</span><br><span class="line"><span class="keyword">from</span> position_handler <span class="keyword">import</span> PositionHandler</span><br><span class="line"><span class="keyword">from</span> order_handler <span class="keyword">import</span> OrderHandler</span><br><span class="line"><span class="keyword">from</span> strategy.strategy <span class="keyword">import</span> BuyHold, ConstantMix, ConstantProportion, \</span><br><span class="line">                              BCDT, NL, PS, MovingAverage, MovingAverage2</span><br><span class="line"><span class="keyword">from</span> performance <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Backtest</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""</span><br><span class="line">    Enscapsulates the settings and components for carrying out</span><br><span class="line">    an event-driven backtest.</span><br><span class="line">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(</span><br><span class="line">            self, symbols, initial_capital,</span><br><span class="line">            start, end, data_handler_cls,</span><br><span class="line">            position_handler_cls, order_handler_cls, strategy_cls, interval, index=None</span><br><span class="line">        )</span>:</span></span><br><span class="line">        <span class="string">"""</span><br><span class="line">        Initialises the backtest.</span><br><span class="line">        Parameters:</span><br><span class="line">        </span><br><span class="line">        symbols - The list of symbol strings.</span><br><span class="line">        intial_capital - The starting capital for the portfolio.</span><br><span class="line">        start - The start datetime of the strategy.</span><br><span class="line">        end - The end datetime of the strategy.</span><br><span class="line">        data_handler_cls - (Class) Handles the market data feed.</span><br><span class="line">        order_handler_cls - (Class) Keeps track of portfolio current</span><br><span class="line">                            and prior positions.</span><br><span class="line">        strategy_cls - (Class) Generates signals based on market data.</span><br><span class="line">        """</span></span><br><span class="line">        self.symbols = symbols</span><br><span class="line">        self.start = start</span><br><span class="line">        self.end = end      </span><br><span class="line">        self.events = Queue.Queue()</span><br><span class="line">        self.interval = interval</span><br><span class="line">        </span><br><span class="line">        self.data_handler = data_handler_cls(self.events, symbols, start, end,</span><br><span class="line">                                             interval, index)</span><br><span class="line">        </span><br><span class="line">        self.position_handler = position_handler_cls(self.data_handler,</span><br><span class="line">                                                     initial_capital)</span><br><span class="line">                                                     </span><br><span class="line">        self.order_handler = order_handler_cls(self.events)</span><br><span class="line">                                               </span><br><span class="line">        self.strategy = strategy_cls(self.data_handler,</span><br><span class="line">                                         self.position_handler,</span><br><span class="line">                                         self.events)</span><br><span class="line">        </span><br><span class="line">        self.orders = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">simulate_trading</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span><br><span class="line">        Executes the backtest.</span><br><span class="line">        """</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            <span class="comment"># Update the market bars</span></span><br><span class="line">            <span class="keyword">if</span> self.data_handler.continue_backtest == <span class="keyword">True</span>:</span><br><span class="line">                self.data_handler.update_bars() <span class="comment"># Produce market event</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">            <span class="comment"># Handle the events</span></span><br><span class="line">            <span class="comment"># If events queue is not empty, do the loop</span></span><br><span class="line">            <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    event = self.events.get(<span class="keyword">False</span>)</span><br><span class="line">                <span class="keyword">except</span> Queue.Empty:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">if</span> event <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">                        <span class="keyword">if</span> event.type == <span class="string">'MARKET'</span>:</span><br><span class="line">                            <span class="comment"># Produce signal event</span></span><br><span class="line">                            <span class="keyword">if</span> self.data_handler.elapsed &gt;= <span class="number">30</span>:</span><br><span class="line">                                self.position_handler.update_from_new(event)</span><br><span class="line">                                self.strategy.generate_signals(event)     </span><br><span class="line">                        <span class="keyword">elif</span> event.type == <span class="string">'SIGNAL'</span>:  </span><br><span class="line">                            <span class="comment"># Produce order</span></span><br><span class="line">                            self.order_handler.generate_order(event)</span><br><span class="line">                        <span class="keyword">elif</span> event.type == <span class="string">'ORDER'</span>:</span><br><span class="line">                            self.orders += <span class="number">1</span></span><br><span class="line">                            <span class="comment"># Produce fill</span></span><br><span class="line">                            self.position_handler.update_from_order(event)</span><br><span class="line">                            </span><br><span class="line">        position_df = pd.DataFrame(</span><br><span class="line">            self.position_handler.historical_position</span><br><span class="line">            )</span><br><span class="line">        position_df.set_index(<span class="string">'datetime'</span>, inplace=<span class="keyword">True</span>)</span><br><span class="line">        position_df[<span class="string">'returns'</span>] = position_df[<span class="string">'total'</span>].pct_change()</span><br><span class="line">        <span class="comment"># Cumulative production, first element NaN</span></span><br><span class="line">        position_df[<span class="string">'cumulative_returns'</span>] = \</span><br><span class="line">            (<span class="number">1.0</span> + position_df[<span class="string">'returns'</span>]).cumprod()</span><br><span class="line">        position_df = position_df.dropna()</span><br><span class="line">        position_df = position_df.loc[:, (<span class="string">'returns'</span>, <span class="string">'cumulative_returns'</span>)]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># The following only valid for Monte Carlo datahandler</span></span><br><span class="line">        self.record = &#123;<span class="string">'mu'</span>: self.data_handler.mu[<span class="number">0</span>], <span class="comment"># markeet</span></span><br><span class="line">                       <span class="string">'sigma'</span>: self.data_handler.sigma[<span class="number">0</span>], <span class="comment"># market</span></span><br><span class="line">                       <span class="string">'performance'</span>: position_df, </span><br><span class="line">                       <span class="string">'orders'</span>: self.orders,</span><br><span class="line">                       <span class="string">'interval'</span>: self.interval</span><br><span class="line">                       &#125;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="comment">#        with open('%s results.pkl' % self.strategy.id, 'wb') as f:</span></span><br><span class="line"><span class="comment">#            cPickle.dump(self.record, f)</span></span><br><span class="line"><span class="comment">#            print('Simulation results have been pickled into file')</span></span><br><span class="line">                                </span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># Get the time index</span></span><br><span class="line">    price_df = web.get_data_yahoo(symbols[<span class="number">0</span>], start, end, interval=<span class="string">'w'</span>)</span><br><span class="line">    <span class="keyword">assert</span> len(price_df.index) &gt;= <span class="number">260</span></span><br><span class="line">    index = price_df.index[:<span class="number">260</span>]   </span><br><span class="line"><span class="comment">#    </span></span><br><span class="line"><span class="comment">#    # Strategy list</span></span><br><span class="line">    strategy = [BuyHold, ConstantMix, ConstantProportion, </span><br><span class="line">                BCDT, NL, PS, MovingAverage, MovingAverage2]   </span><br><span class="line">    <span class="comment">##############################################</span></span><br><span class="line">    <span class="comment"># Loop over all strategies, each 10000 times #</span></span><br><span class="line">    <span class="comment">##############################################</span></span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> strategy:     </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">10000</span>):</span><br><span class="line">            backtest = Backtest(</span><br><span class="line">                    symbols, initial_capital, start, </span><br><span class="line">                    end, MonteCarloDataHandler, PositionHandler,</span><br><span class="line">                    OrderHandler, s, <span class="string">'w'</span>, index</span><br><span class="line">                    )</span><br><span class="line">            backtest.simulate_trading()</span><br><span class="line">            p = backtest.record</span><br><span class="line">            repo = backtest.strategy.id.strip().split(<span class="string">' '</span>)[<span class="number">-1</span>]</span><br><span class="line">            <span class="keyword">with</span> open(<span class="string">'%s/%d.pkl'</span> % (repo, i+<span class="number">1</span>), <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                cPickle.dump(backtest.record, f)</span><br><span class="line">            print(<span class="string">'Simulation %d finished'</span> % (i+<span class="number">1</span>,))</span><br><span class="line">            <span class="comment">#output_performance('%s/%d.pkl' % (repo, i+1), repo)</span></span><br></pre></td></tr></table></figure></p>
<p><strong> Strategy module:</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABCMeta, abstractmethod</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> scipy.stats <span class="keyword">import</span> norm</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> event <span class="keyword">import</span> SignalEvent</span><br><span class="line">           </span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BuyHold</span><span class="params">(BaseStrategy)</span>:</span></span><br><span class="line">    <span class="string">"""</span><br><span class="line">    Keep initial quantities constant.</span><br><span class="line">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(</span><br><span class="line">    self, data_handler, position_handler, events, ratio=<span class="number">0.5</span>, mode=<span class="string">'even'</span>)</span>:</span></span><br><span class="line">        <span class="string">"""</span><br><span class="line">        @Parameters:</span><br><span class="line">        evnets - Events queue shared with backtest.</span><br><span class="line">        bought - 'OUT', 'LONG' or 'SHORT'.</span><br><span class="line">        ratio - The proportion of risky component.</span><br><span class="line">        mode - Useful for multi-stock model. For the project, I didn't </span><br><span class="line">               implement this funcionality.</span><br><span class="line">        """</span></span><br><span class="line">        self.id = <span class="string">'Buy Hold (BH)'</span></span><br><span class="line">        self.data_handler = data_handler</span><br><span class="line">        self.position_handler = position_handler</span><br><span class="line">        self.symbols = self.data_handler.symbols</span><br><span class="line">        self.events = events</span><br><span class="line">        self.ratio = ratio</span><br><span class="line">        self.mode = mode</span><br><span class="line">        self.bought = dict((s, <span class="string">'OUT'</span>) <span class="keyword">for</span> s <span class="keyword">in</span> self.symbols)</span><br><span class="line">                </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate_signals</span><span class="params">(self, event)</span>:</span></span><br><span class="line">        <span class="string">"""</span><br><span class="line">        Generate buy signal at the beginning and do not do anything later.</span><br><span class="line">        """</span></span><br><span class="line">        <span class="keyword">assert</span> event.type == <span class="string">'MARKET'</span></span><br><span class="line">        symbols = []</span><br><span class="line">        prices = []</span><br><span class="line">        quantities = []</span><br><span class="line">        directions = []</span><br><span class="line">        time = self.data_handler.get_latest_bar(self.symbols[<span class="number">0</span>])[<span class="number">0</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment">############################</span></span><br><span class="line">        <span class="comment"># Assume evenly allocation #</span></span><br><span class="line">        <span class="comment">############################</span></span><br><span class="line">        risky_alloc = self.position_handler.initial_capital * self.ratio</span><br><span class="line">        num = len(self.symbols)</span><br><span class="line">        individual_alloc = risky_alloc / num </span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> symbol <span class="keyword">in</span> self.symbols:</span><br><span class="line">            <span class="keyword">if</span> self.bought[symbol] != <span class="string">'OUT'</span>:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">else</span>: </span><br><span class="line">                price = self.data_handler.get_latest_bar_value(symbol,</span><br><span class="line">                    <span class="string">'Adj Close'</span>)</span><br><span class="line">                symbols.append(symbol)</span><br><span class="line">                prices.append(price)</span><br><span class="line">                </span><br><span class="line">                <span class="comment">###############################</span></span><br><span class="line">                <span class="comment"># Calculate quantities needed #</span></span><br><span class="line">                <span class="comment">###############################                            </span></span><br><span class="line">                quantity = round(individual_alloc / price, <span class="number">4</span>)</span><br><span class="line">                quantities.append(quantity)</span><br><span class="line">                               </span><br><span class="line">                directions.append(<span class="string">'BUY'</span>)</span><br><span class="line">                self.bought[symbol] = <span class="string">'LONG'</span>     </span><br><span class="line">        </span><br><span class="line">        self.events.put(SignalEvent(time, symbols,</span><br><span class="line">                                    np.array(prices), np.array(quantities), </span><br><span class="line">                                    directions))</span><br><span class="line">                                    </span><br><span class="line">                                    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConstantMix</span><span class="params">(BaseStrategy)</span>:</span></span><br><span class="line">    <span class="string">"""</span><br><span class="line">    Keep the initial portfolio share constant, i.e. the ratio between the</span><br><span class="line">    values of risky asset and risk-free asset is constant.</span><br><span class="line"></span><br><span class="line">    Rebalance on a weekly basis.</span><br><span class="line">    No short selling allowed.</span><br><span class="line">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(</span><br><span class="line">    self, data_handler, position_handler, events, ratio=<span class="number">0.5</span>, mode=<span class="string">'even'</span>)</span>:</span></span><br><span class="line">        <span class="string">"""</span><br><span class="line">        @Parameters:</span><br><span class="line">        evnets - Events queue shared with backtest.</span><br><span class="line">        ratio - The proportion of risky component.</span><br><span class="line">        mode - Useful for multi-stock model. For the project, I didn't </span><br><span class="line">               implement this funcionality.</span><br><span class="line">        """</span></span><br><span class="line">        self.id = <span class="string">'Constant Mix (CM)'</span></span><br><span class="line">        self.data_handler = data_handler</span><br><span class="line">        self.position_handler = position_handler</span><br><span class="line">        self.symbols = self.data_handler.symbols</span><br><span class="line">        self.events = events</span><br><span class="line">        self.ratio = ratio</span><br><span class="line">        self.mode = mode</span><br><span class="line">                </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate_signals</span><span class="params">(self, event)</span>:</span></span><br><span class="line">        <span class="string">"""</span><br><span class="line">        Implement the strategy.</span><br><span class="line">        """</span></span><br><span class="line">        <span class="keyword">assert</span> event.type == <span class="string">'MARKET'</span></span><br><span class="line">        symbols = []</span><br><span class="line">        prices = []</span><br><span class="line">        quantities = []</span><br><span class="line">        directions = []</span><br><span class="line">        time = self.data_handler.get_latest_bar(self.symbols[<span class="number">0</span>])[<span class="number">0</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment">############################</span></span><br><span class="line">        <span class="comment"># Assume evenly allocation #</span></span><br><span class="line">        <span class="comment">############################</span></span><br><span class="line">        portfolio_value = self.position_handler.current_position[<span class="string">'total'</span>]</span><br><span class="line">        risky_alloc = portfolio_value * self.ratio</span><br><span class="line">        </span><br><span class="line">        num = len(self.symbols)</span><br><span class="line">        individual_alloc = risky_alloc / num</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> symbol <span class="keyword">in</span> self.symbols:</span><br><span class="line">            trigger = <span class="keyword">False</span></span><br><span class="line">            price = self.data_handler.get_latest_bar_value(symbol, <span class="string">'Adj Close'</span>)</span><br><span class="line">            quantity = <span class="number">0.</span></span><br><span class="line">            direction = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">##################################</span></span><br><span class="line">            <span class="comment"># Test whether need to rebalance #</span></span><br><span class="line">            <span class="comment">##################################</span></span><br><span class="line">            mkt_value = self.position_handler.current_position[symbol][<span class="number">2</span>]</span><br><span class="line">              </span><br><span class="line">            <span class="keyword">if</span> abs(individual_alloc/mkt_value - <span class="number">1.</span>) &gt; <span class="number">1e-2</span>:</span><br><span class="line">                direction = <span class="string">'BUY'</span> <span class="keyword">if</span> individual_alloc &gt; mkt_value <span class="keyword">else</span> <span class="string">'SELL'</span></span><br><span class="line">                quantity = round(abs(individual_alloc - mkt_value) / price, <span class="number">4</span>)  </span><br><span class="line">                trigger = <span class="keyword">True</span> <span class="keyword">if</span> quantity != <span class="number">0.</span> <span class="keyword">else</span> <span class="keyword">False</span></span><br><span class="line"> </span><br><span class="line">            <span class="keyword">if</span> trigger:    </span><br><span class="line">                symbols.append(symbol)</span><br><span class="line">                prices.append(price)</span><br><span class="line">                quantities.append(quantity)</span><br><span class="line">                directions.append(direction)  </span><br><span class="line">                </span><br><span class="line">        <span class="keyword">if</span> len(symbols) != <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># only release signal when the lists are not empty</span></span><br><span class="line">            self.events.put(SignalEvent(time, symbols,</span><br><span class="line">                                        np.array(prices), np.array(quantities), </span><br><span class="line">                                        directions))</span><br><span class="line">                                        </span><br><span class="line">                                        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConstantProportion</span><span class="params">(BaseStrategy)</span>:</span></span><br><span class="line">    <span class="string">"""</span><br><span class="line">    Keep the risky component over the cusion fixed.</span><br><span class="line">    </span><br><span class="line">    E_t = min(A_t, m(A_t - F_t)^+), where F_0 * exp(rT) = K, m is fixed.</span><br><span class="line">    </span><br><span class="line">    Rebalance on a weekly basis.</span><br><span class="line">    No short selling allowed.</span><br><span class="line">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(</span><br><span class="line">    self, data_handler, position_handler, events, m=<span class="number">2.</span>, interval=<span class="string">'w'</span>, mode=<span class="string">'even'</span>)</span>:</span></span><br><span class="line">        <span class="string">"""</span><br><span class="line">        @Parameters:</span><br><span class="line">        evnets - Events queue shared with backtest.</span><br><span class="line">        m - The multiplier with respect to the cushion.</span><br><span class="line">        floor - The granted level at time T.</span><br><span class="line">        mode - Useful for multi-stock model. For the project, I didn't </span><br><span class="line">               implement this funcionality.</span><br><span class="line">        initialized - Since the starting portfolio is 50-50 stock-cash, this </span><br><span class="line">                      helps to specify the different allocation strategy.</span><br><span class="line">        """</span></span><br><span class="line">        self.id = <span class="string">'Constant Proportion (CPPI)'</span></span><br><span class="line">        self.data_handler = data_handler</span><br><span class="line">        self.position_handler = position_handler</span><br><span class="line">        self.symbols = data_handler.symbols</span><br><span class="line">        self.events = events</span><br><span class="line">        self.m = m</span><br><span class="line">        self.interval = interval</span><br><span class="line">        self.floor = position_handler.initial_capital</span><br><span class="line">        self.r = data_handler.r</span><br><span class="line">        self.T = data_handler.T</span><br><span class="line">        self.mode = mode</span><br><span class="line">        self.initialized = <span class="keyword">False</span></span><br><span class="line">                </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate_signals</span><span class="params">(self, event)</span>:</span></span><br><span class="line">        <span class="string">"""</span><br><span class="line">        Implement the strategy.</span><br><span class="line">        """</span></span><br><span class="line">        <span class="keyword">assert</span> event.type == <span class="string">'MARKET'</span></span><br><span class="line">        symbols = []</span><br><span class="line">        prices = []</span><br><span class="line">        quantities = []</span><br><span class="line">        directions = []</span><br><span class="line">        time = self.data_handler.get_latest_bar(self.symbols[<span class="number">0</span>])[<span class="number">0</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment">############################</span></span><br><span class="line">        <span class="comment"># Assume evenly allocation #</span></span><br><span class="line">        <span class="comment">############################            </span></span><br><span class="line">        basis = <span class="number">252.</span> <span class="keyword">if</span> self.interval==<span class="string">'d'</span> <span class="keyword">else</span> <span class="number">52.</span> <span class="keyword">if</span> self.interval==<span class="string">'w'</span> <span class="keyword">else</span> <span class="number">12.</span></span><br><span class="line">        <span class="comment"># since the strategy starts at 101st iteration,</span></span><br><span class="line">        <span class="comment"># also note that this is a weekly strategy, denominator = 52.</span></span><br><span class="line">        T = self.T - self.position_handler.elapsed / basis</span><br><span class="line">        portfolio_value = self.position_handler.current_position[<span class="string">'total'</span>]</span><br><span class="line">        </span><br><span class="line">        risky_alloc = <span class="number">0.</span></span><br><span class="line">        <span class="keyword">if</span> self.initialized:</span><br><span class="line">            risky_alloc = min(</span><br><span class="line">                portfolio_value,</span><br><span class="line">                max(</span><br><span class="line">                    self.m*(portfolio_value - self.floor*np.exp(-self.r * T)),</span><br><span class="line">                    <span class="number">0.</span></span><br><span class="line">                    )</span><br><span class="line">                )</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            risky_alloc = portfolio_value * <span class="number">0.5</span></span><br><span class="line">            self.initialized = <span class="keyword">True</span></span><br><span class="line">            </span><br><span class="line">        num = len(self.symbols)</span><br><span class="line">        individual_alloc = risky_alloc / num </span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> symbol <span class="keyword">in</span> self.symbols:</span><br><span class="line">            trigger = <span class="keyword">False</span></span><br><span class="line">            price = self.data_handler.get_latest_bar_value(symbol, <span class="string">'Adj Close'</span>)</span><br><span class="line">            quantity = <span class="number">0.</span></span><br><span class="line">            direction = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">##################################</span></span><br><span class="line">            <span class="comment"># Test whether need to rebalance #</span></span><br><span class="line">            <span class="comment">##################################</span></span><br><span class="line">            mkt_value = self.position_handler.current_position[symbol][<span class="number">2</span>]</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> abs(individual_alloc/mkt_value - <span class="number">1.</span>) &gt; <span class="number">1e-2</span>:</span><br><span class="line">                direction = <span class="string">'BUY'</span> <span class="keyword">if</span> individual_alloc &gt; mkt_value <span class="keyword">else</span> <span class="string">'SELL'</span></span><br><span class="line">                quantity = round(abs(individual_alloc - mkt_value) / price, <span class="number">4</span>)  </span><br><span class="line">                trigger = <span class="keyword">True</span> <span class="keyword">if</span> quantity != <span class="number">0.</span> <span class="keyword">else</span> <span class="keyword">False</span></span><br><span class="line">  </span><br><span class="line">            <span class="keyword">if</span> trigger:    </span><br><span class="line">                symbols.append(symbol)</span><br><span class="line">                prices.append(price)</span><br><span class="line">                quantities.append(quantity)</span><br><span class="line">                directions.append(direction)  </span><br><span class="line">                </span><br><span class="line">        <span class="keyword">if</span> len(symbols) != <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># only release signal when the lists are not empty</span></span><br><span class="line">            self.events.put(SignalEvent(time, symbols,</span><br><span class="line">                                        np.array(prices), np.array(quantities), </span><br><span class="line">                                        directions))</span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################</span></span><br><span class="line"><span class="comment"># Utility function for option based strategy #  </span></span><br><span class="line"><span class="comment">##############################################</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">d_1</span><span class="params">(S, r, K, T, sigma)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> (np.log(S/K) + (r+<span class="number">0.5</span>*sigma**<span class="number">2</span>)*T) / (sigma * np.sqrt(T))</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">d_2</span><span class="params">(S, r, K, T, sigma)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> (np.log(S/K) + (r<span class="number">-0.5</span>*sigma**<span class="number">2</span>)*T) / (sigma * np.sqrt(T))</span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(S, r, K, T, sigma)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> S*norm.cdf(d_1(S, r, K, T, sigma)) - \</span><br><span class="line">        K*np.exp(-r*T)*norm.cdf(d_2(S, r, K, T, sigma))    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(S, r, K, T, sigma)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> -S*norm.cdf(-d_1(S, r, K, T, sigma)) + \</span><br><span class="line">        K*np.exp(-r*T)*norm.cdf(-d_2(S, r, K, T, sigma))                        </span><br><span class="line"></span><br><span class="line"><span class="comment">######################################</span></span><br><span class="line"><span class="comment"># f(S) = C(S,K) + K*exp(-rT) - K = 0 #</span></span><br><span class="line"><span class="comment">######################################</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">newton_solver</span><span class="params">(S, r, K, T, sigma)</span>:</span></span><br><span class="line">    d1 = <span class="keyword">lambda</span> x: (np.log(x/K) + (r+<span class="number">0.5</span>*sigma**<span class="number">2</span>)*T) / \</span><br><span class="line">        (sigma * np.sqrt(T))</span><br><span class="line">    d2 = <span class="keyword">lambda</span> x: d1(x) - sigma * np.sqrt(T)</span><br><span class="line">    f = <span class="keyword">lambda</span> x: x*norm.cdf(d1(x)) + K*np.exp(-r*T)*norm.cdf(-d2(x)) - K</span><br><span class="line">    S = S</span><br><span class="line">    <span class="keyword">while</span>(abs(f(S)) &gt; <span class="number">1e-3</span>):</span><br><span class="line">        S -= f(S) / norm.cdf(d1(S))</span><br><span class="line">    <span class="keyword">assert</span> np.isfinite(S)</span><br><span class="line">    <span class="keyword">return</span> S</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BCDT</span><span class="params">(BaseStrategy)</span>:</span></span><br><span class="line">    <span class="string">"""</span><br><span class="line">    Reference Bird et al. (1990)</span><br><span class="line">    </span><br><span class="line">    Single stock strategy. Initial stock price must equal to initial capital.</span><br><span class="line">    </span><br><span class="line">    Rebalance on a weekly basis.</span><br><span class="line">    No short selling allowed.</span><br><span class="line">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(</span><br><span class="line">    self, data_handler, position_handler, events, interval=<span class="string">'w'</span>, mode=<span class="string">'even'</span>)</span>:</span></span><br><span class="line">        <span class="string">"""</span><br><span class="line">        @Parameters:</span><br><span class="line">        evnets - Events queue shared with backtest.</span><br><span class="line">        m - The multiplier with respect to the cushion.</span><br><span class="line">        K - The granted level at time T.</span><br><span class="line">        mode - Useful for multi-stock model. For the project, I didn't </span><br><span class="line">               implement this funcionality.</span><br><span class="line">        initialized - Since the starting portfolio is 50-50 stock-cash, this </span><br><span class="line">                      helps to specify the different allocation strategy.</span><br><span class="line">        """</span></span><br><span class="line">        self.id = <span class="string">'Option Based (BCDT)'</span></span><br><span class="line">        self.data_handler = data_handler</span><br><span class="line">        self.position_handler = position_handler</span><br><span class="line">        self.symbols = data_handler.symbols</span><br><span class="line">        <span class="keyword">assert</span> len(self.symbols) == <span class="number">1</span></span><br><span class="line">        self.events = events</span><br><span class="line">        self.interval = interval</span><br><span class="line">        self.K = position_handler.initial_capital</span><br><span class="line">        self.r = data_handler.r</span><br><span class="line">        self.T = data_handler.T</span><br><span class="line">        self.mode = mode</span><br><span class="line">        self.vol_period = <span class="number">100</span></span><br><span class="line">        self.initialized = <span class="keyword">False</span></span><br><span class="line">                </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate_signals</span><span class="params">(self, event)</span>:</span></span><br><span class="line">        <span class="string">"""</span><br><span class="line">        Implement the strategy.</span><br><span class="line">        """</span></span><br><span class="line">        <span class="keyword">assert</span> event.type == <span class="string">'MARKET'</span></span><br><span class="line">        symbols = []</span><br><span class="line">        prices = []</span><br><span class="line">        quantities = []</span><br><span class="line">        directions = []</span><br><span class="line">        time = self.data_handler.get_latest_bar(self.symbols[<span class="number">0</span>])[<span class="number">0</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment">############################</span></span><br><span class="line">        <span class="comment"># Assume evenly allocation #</span></span><br><span class="line">        <span class="comment">############################  </span></span><br><span class="line">        portfolio_value = self.position_handler.current_position[<span class="string">'total'</span>]          </span><br><span class="line">        basis = <span class="number">252.</span> <span class="keyword">if</span> self.interval==<span class="string">'d'</span> <span class="keyword">else</span> <span class="number">52.</span> <span class="keyword">if</span> self.interval==<span class="string">'w'</span> <span class="keyword">else</span> <span class="number">12.</span></span><br><span class="line">        <span class="comment">###############################</span></span><br><span class="line">        <span class="comment"># Parameters for option value #</span></span><br><span class="line">        <span class="comment">###############################</span></span><br><span class="line">        T = self.T - self.vol_period/basis - self.position_handler.elapsed / basis</span><br><span class="line">        S = self.data_handler.get_latest_bar_value(self.symbols[<span class="number">0</span>], <span class="string">'Adj Close'</span>)</span><br><span class="line">        </span><br><span class="line">        sigma = <span class="number">0.</span></span><br><span class="line">        <span class="keyword">if</span> self.data_handler.elapsed &lt; self.vol_period:</span><br><span class="line">            sigma = self.data_handler.sigma[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            recent_prices = self.data_handler.get_recent_bars_values(</span><br><span class="line">            self.symbols[<span class="number">0</span>], <span class="string">'Adj Close'</span>, self.vol_period)</span><br><span class="line">            sigma = np.std(recent_prices, ddof=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        sigma_adj = sigma * np.sqrt(<span class="number">1</span>+<span class="number">0.003</span>/sigma*np.sqrt(<span class="number">2</span>*<span class="number">52.</span>/np.pi))</span><br><span class="line">        d1 = d_1(S, self.r, self.K, T, sigma_adj)</span><br><span class="line">            </span><br><span class="line">        risky_alloc = <span class="number">0.</span></span><br><span class="line">        <span class="keyword">if</span> self.initialized:</span><br><span class="line">            risky_alloc = self.g * S * norm.cdf(d1)</span><br><span class="line">           <span class="comment"># print (risky_alloc / portfolio_value)</span></span><br><span class="line">                </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            risky_alloc = portfolio_value * <span class="number">0.5</span></span><br><span class="line">            <span class="comment">########################################</span></span><br><span class="line">            <span class="comment"># Calculate g and B_0 at the beginning #</span></span><br><span class="line">            <span class="comment">########################################</span></span><br><span class="line">            call0 = call(self.K, self.r, self.K, T, sigma_adj)</span><br><span class="line">            self.g = (self.K - self.K*np.exp(-self.r*T)) / call0</span><br><span class="line">   </span><br><span class="line">            self.initialized = <span class="keyword">True</span></span><br><span class="line">       </span><br><span class="line">        num = len(self.symbols)</span><br><span class="line">        individual_alloc = risky_alloc / num </span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> symbol <span class="keyword">in</span> self.symbols:</span><br><span class="line">            trigger = <span class="keyword">False</span></span><br><span class="line">            price = self.data_handler.get_latest_bar_value(symbol, <span class="string">'Adj Close'</span>)</span><br><span class="line">            quantity = <span class="number">0.</span></span><br><span class="line">            direction = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">##################################</span></span><br><span class="line">            <span class="comment"># Test whether need to rebalance #</span></span><br><span class="line">            <span class="comment">##################################</span></span><br><span class="line">            mkt_value = self.position_handler.current_position[symbol][<span class="number">2</span>]</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> abs(individual_alloc/mkt_value - <span class="number">1.</span>) &gt; <span class="number">1e-2</span>:</span><br><span class="line">                direction = <span class="string">'BUY'</span> <span class="keyword">if</span> individual_alloc &gt; mkt_value <span class="keyword">else</span> <span class="string">'SELL'</span></span><br><span class="line">                quantity = round(abs(individual_alloc - mkt_value) / price, <span class="number">4</span>)</span><br><span class="line">                trigger = <span class="keyword">True</span> <span class="keyword">if</span> quantity != <span class="number">0.</span> <span class="keyword">else</span> <span class="keyword">False</span></span><br><span class="line">  </span><br><span class="line">            <span class="keyword">if</span> trigger:    </span><br><span class="line">                symbols.append(symbol)</span><br><span class="line">                prices.append(price)</span><br><span class="line">                quantities.append(quantity)</span><br><span class="line">                directions.append(direction)  </span><br><span class="line">                </span><br><span class="line">        <span class="keyword">if</span> len(symbols) != <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># only release signal when the lists are not empty</span></span><br><span class="line">            self.events.put(SignalEvent(time, symbols,</span><br><span class="line">                                        np.array(prices), np.array(quantities), </span><br><span class="line">                                        directions))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NL</span><span class="params">(BaseStrategy)</span>:</span></span><br><span class="line">    <span class="string">"""   </span><br><span class="line">    Single stock strategy.</span><br><span class="line">    </span><br><span class="line">    Rebalance on a weekly basis.</span><br><span class="line">    No short selling allowed.</span><br><span class="line">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(</span><br><span class="line">    self, data_handler, position_handler, events, interval=<span class="string">'w'</span>, mode=<span class="string">'even'</span>)</span>:</span></span><br><span class="line">        <span class="string">"""</span><br><span class="line">        @Parameters:</span><br><span class="line">        evnets - Events queue shared with backtest.</span><br><span class="line">        m - The multiplier with respect to the cushion.</span><br><span class="line">        K - The granted level at time T.</span><br><span class="line">        mode - Useful for multi-stock model. For the project, I didn't </span><br><span class="line">               implement this funcionality.</span><br><span class="line">        initialized - Since the starting portfolio is 50-50 stock-cash, this </span><br><span class="line">                      helps to specify the different allocation strategy.</span><br><span class="line">        """</span></span><br><span class="line">        self.id = <span class="string">'Option Based (NL)'</span></span><br><span class="line">        self.data_handler = data_handler</span><br><span class="line">        self.position_handler = position_handler</span><br><span class="line">        self.symbols = data_handler.symbols</span><br><span class="line">        <span class="keyword">assert</span> len(self.symbols) == <span class="number">1</span></span><br><span class="line">        self.events = events</span><br><span class="line">        self.interval = interval</span><br><span class="line">        self.K = position_handler.initial_capital</span><br><span class="line">        self.r = data_handler.r</span><br><span class="line">        self.T = data_handler.T</span><br><span class="line">        self.mode = mode</span><br><span class="line">        self.vol_period = <span class="number">100</span> <span class="comment"># period used to estimate volatility</span></span><br><span class="line">        self.initialized = <span class="keyword">False</span></span><br><span class="line">                </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate_signals</span><span class="params">(self, event)</span>:</span></span><br><span class="line">        <span class="string">"""</span><br><span class="line">        Implement the strategy.</span><br><span class="line">        """</span></span><br><span class="line">        <span class="keyword">assert</span> event.type == <span class="string">'MARKET'</span></span><br><span class="line">        symbols = []</span><br><span class="line">        prices = []</span><br><span class="line">        quantities = []</span><br><span class="line">        directions = []</span><br><span class="line">        time = self.data_handler.get_latest_bar(self.symbols[<span class="number">0</span>])[<span class="number">0</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment">############################</span></span><br><span class="line">        <span class="comment"># Assume evenly allocation #</span></span><br><span class="line">        <span class="comment">############################  </span></span><br><span class="line">        portfolio_value = self.position_handler.current_position[<span class="string">'total'</span>]          </span><br><span class="line">        basis = <span class="number">252.</span> <span class="keyword">if</span> self.interval==<span class="string">'d'</span> <span class="keyword">else</span> <span class="number">52.</span> <span class="keyword">if</span> self.interval==<span class="string">'w'</span> <span class="keyword">else</span> <span class="number">12.</span></span><br><span class="line">        <span class="comment">###############################</span></span><br><span class="line">        <span class="comment"># Parameters for option value #</span></span><br><span class="line">        <span class="comment">###############################</span></span><br><span class="line">        T = self.T - self.vol_period/basis - self.position_handler.elapsed / basis</span><br><span class="line">        S = self.data_handler.get_latest_bar_value(self.symbols[<span class="number">0</span>], <span class="string">'Adj Close'</span>)</span><br><span class="line">        </span><br><span class="line">        sigma = <span class="number">0.</span></span><br><span class="line">        <span class="keyword">if</span> self.data_handler.elapsed &lt; self.vol_period:</span><br><span class="line">            sigma = self.data_handler.sigma[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            recent_prices = self.data_handler.get_recent_bars_values(</span><br><span class="line">            self.symbols[<span class="number">0</span>], <span class="string">'Adj Close'</span>, self.vol_period)</span><br><span class="line">            sigma = np.std(recent_prices, ddof=<span class="number">1</span>)</span><br><span class="line">        sigma_adj = sigma * np.sqrt(<span class="number">1</span>+<span class="number">0.003</span>/sigma*np.sqrt(<span class="number">2</span>*<span class="number">52.</span>/np.pi)) </span><br><span class="line">        </span><br><span class="line">        risky_alloc = <span class="number">0.</span></span><br><span class="line">        <span class="keyword">if</span> self.initialized:</span><br><span class="line">            d1_0 = d_1(S*self.h, self.r, self.K, T, sigma_adj)</span><br><span class="line">            risky_alloc = norm.cdf(d1_0) * self.h * S</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            risky_alloc = portfolio_value * <span class="number">0.5</span></span><br><span class="line">            <span class="comment">################################</span></span><br><span class="line">            <span class="comment"># Calculate h at the beginning #</span></span><br><span class="line">            <span class="comment">################################</span></span><br><span class="line">            S_0 = newton_solver(self.K, self.r, self.K, self.T, sigma_adj)</span><br><span class="line">            self.h = S_0 / S</span><br><span class="line">            self.initialized = <span class="keyword">True</span></span><br><span class="line">       </span><br><span class="line">        num = len(self.symbols)</span><br><span class="line">        individual_alloc = risky_alloc / num </span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> symbol <span class="keyword">in</span> self.symbols:</span><br><span class="line">            trigger = <span class="keyword">False</span></span><br><span class="line">            price = self.data_handler.get_latest_bar_value(symbol, <span class="string">'Adj Close'</span>)</span><br><span class="line">            quantity = <span class="number">0.</span></span><br><span class="line">            direction = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">##################################</span></span><br><span class="line">            <span class="comment"># Test whether need to rebalance #</span></span><br><span class="line">            <span class="comment">##################################</span></span><br><span class="line">            mkt_value = self.position_handler.current_position[symbol][<span class="number">2</span>]</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> abs(individual_alloc/mkt_value - <span class="number">1.</span>) &gt; <span class="number">1e-2</span>:</span><br><span class="line">                direction = <span class="string">'BUY'</span> <span class="keyword">if</span> individual_alloc &gt; mkt_value <span class="keyword">else</span> <span class="string">'SELL'</span></span><br><span class="line">                quantity = round(abs(individual_alloc - mkt_value) / price, <span class="number">4</span>)  </span><br><span class="line">                trigger = <span class="keyword">True</span> <span class="keyword">if</span> quantity != <span class="number">0.</span> <span class="keyword">else</span> <span class="keyword">False</span></span><br><span class="line">  </span><br><span class="line">            <span class="keyword">if</span> trigger:    </span><br><span class="line">                symbols.append(symbol)</span><br><span class="line">                prices.append(price)</span><br><span class="line">                quantities.append(quantity)</span><br><span class="line">                directions.append(direction)  </span><br><span class="line">                </span><br><span class="line">        <span class="keyword">if</span> len(symbols) != <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># only release signal when the lists are not empty</span></span><br><span class="line">            self.events.put(SignalEvent(time, symbols,</span><br><span class="line">                                        np.array(prices), np.array(quantities), </span><br><span class="line">                                        directions))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PS</span><span class="params">(BaseStrategy)</span>:</span></span><br><span class="line">    <span class="string">"""   </span><br><span class="line">    Single stock strategy.</span><br><span class="line">    </span><br><span class="line">    Rebalance on a weekly basis.</span><br><span class="line">    No short selling allowed.</span><br><span class="line">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(</span><br><span class="line">    self, data_handler, position_handler, events, interval=<span class="string">'w'</span>, mode=<span class="string">'even'</span>)</span>:</span></span><br><span class="line">        <span class="string">"""</span><br><span class="line">        @Parameters:</span><br><span class="line">        evnets - Events queue shared with backtest.</span><br><span class="line">        m - The multiplier with respect to the cushion.</span><br><span class="line">        K - The granted level at time T.</span><br><span class="line">        mode - Useful for multi-stock model. For the project, I didn't </span><br><span class="line">               implement this funcionality.</span><br><span class="line">        initialized - Since the starting portfolio is 50-50 stock-cash, this </span><br><span class="line">                      helps to specify the different allocation strategy.</span><br><span class="line">        """</span></span><br><span class="line">        self.id = <span class="string">'Option Based (PS)'</span></span><br><span class="line">        self.data_handler = data_handler</span><br><span class="line">        self.position_handler = position_handler</span><br><span class="line">        self.symbols = data_handler.symbols</span><br><span class="line">        <span class="keyword">assert</span> len(self.symbols) == <span class="number">1</span></span><br><span class="line">        self.events = events</span><br><span class="line">        self.interval = interval</span><br><span class="line">        self.K = position_handler.initial_capital</span><br><span class="line">        self.r = data_handler.r</span><br><span class="line">        self.T = data_handler.T</span><br><span class="line">        self.mode = mode</span><br><span class="line">        self.vol_period = <span class="number">100</span></span><br><span class="line">        self.initialized = <span class="keyword">False</span></span><br><span class="line">                </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate_signals</span><span class="params">(self, event)</span>:</span></span><br><span class="line">        <span class="string">"""</span><br><span class="line">        Implement the strategy.</span><br><span class="line">        """</span></span><br><span class="line">        <span class="keyword">assert</span> event.type == <span class="string">'MARKET'</span></span><br><span class="line">        symbols = []</span><br><span class="line">        prices = []</span><br><span class="line">        quantities = []</span><br><span class="line">        directions = []</span><br><span class="line">        time = self.data_handler.get_latest_bar(self.symbols[<span class="number">0</span>])[<span class="number">0</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment">############################</span></span><br><span class="line">        <span class="comment"># Assume evenly allocation #</span></span><br><span class="line">        <span class="comment">############################  </span></span><br><span class="line">        portfolio_value = self.position_handler.current_position[<span class="string">'total'</span>]          </span><br><span class="line">        basis = <span class="number">252.</span> <span class="keyword">if</span> self.interval==<span class="string">'d'</span> <span class="keyword">else</span> <span class="number">52.</span> <span class="keyword">if</span> self.interval==<span class="string">'w'</span> <span class="keyword">else</span> <span class="number">12.</span></span><br><span class="line">        <span class="comment">###############################</span></span><br><span class="line">        <span class="comment"># Parameters for option value #</span></span><br><span class="line">        <span class="comment">###############################</span></span><br><span class="line">        T = self.T - self.vol_period/basis - self.position_handler.elapsed / basis</span><br><span class="line">        S = self.data_handler.get_latest_bar_value(self.symbols[<span class="number">0</span>], <span class="string">'Adj Close'</span>)</span><br><span class="line">        </span><br><span class="line">        sigma = <span class="number">0.</span></span><br><span class="line">        <span class="keyword">if</span> self.data_handler.elapsed &lt; self.vol_period:</span><br><span class="line">            sigma = self.data_handler.sigma[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            recent_prices = self.data_handler.get_recent_bars_values(</span><br><span class="line">            self.symbols[<span class="number">0</span>], <span class="string">'Adj Close'</span>, self.vol_period)</span><br><span class="line">            sigma = np.std(recent_prices, ddof=<span class="number">1</span>)</span><br><span class="line">            </span><br><span class="line">        sigma_adj = sigma * np.sqrt(<span class="number">1</span>+<span class="number">0.003</span>/sigma*np.sqrt(<span class="number">2</span>*<span class="number">52.</span>/np.pi)) </span><br><span class="line">        d1 = d_1(S, self.r, self.K, T, sigma_adj)</span><br><span class="line">        </span><br><span class="line">        risky_alloc = <span class="number">0.</span></span><br><span class="line">        <span class="keyword">if</span> self.initialized:</span><br><span class="line">            risky_alloc = norm.cdf(d1) * self.n * S</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            risky_alloc = portfolio_value * <span class="number">0.5</span></span><br><span class="line">            <span class="comment">################################</span></span><br><span class="line">            <span class="comment"># Calculate h at the beginning #</span></span><br><span class="line">            <span class="comment">################################</span></span><br><span class="line">            call0 = call(S, self.r, self.K, T, sigma_adj)</span><br><span class="line">            self.n = self.K / (call0 + self.K*np.exp(-self.r*T))</span><br><span class="line">            self.initialized = <span class="keyword">True</span></span><br><span class="line">            </span><br><span class="line">        num = len(self.symbols)</span><br><span class="line">        individual_alloc = risky_alloc / num </span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> symbol <span class="keyword">in</span> self.symbols:</span><br><span class="line">            trigger = <span class="keyword">False</span></span><br><span class="line">            price = self.data_handler.get_latest_bar_value(symbol, <span class="string">'Adj Close'</span>)</span><br><span class="line">            quantity = <span class="number">0.</span></span><br><span class="line">            direction = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">##################################</span></span><br><span class="line">            <span class="comment"># Test whether need to rebalance #</span></span><br><span class="line">            <span class="comment">##################################</span></span><br><span class="line">            mkt_value = self.position_handler.current_position[symbol][<span class="number">2</span>]</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> abs(individual_alloc/mkt_value - <span class="number">1.</span>) &gt; <span class="number">1e-2</span>:</span><br><span class="line">                direction = <span class="string">'BUY'</span> <span class="keyword">if</span> individual_alloc &gt; mkt_value <span class="keyword">else</span> <span class="string">'SELL'</span></span><br><span class="line">                quantity = round(abs(individual_alloc - mkt_value) / price, <span class="number">4</span>)  </span><br><span class="line">                trigger = <span class="keyword">True</span> <span class="keyword">if</span> quantity != <span class="number">0.</span> <span class="keyword">else</span> <span class="keyword">False</span></span><br><span class="line">  </span><br><span class="line">            <span class="keyword">if</span> trigger:    </span><br><span class="line">                symbols.append(symbol)</span><br><span class="line">                prices.append(price)</span><br><span class="line">                quantities.append(quantity)</span><br><span class="line">                directions.append(direction)  </span><br><span class="line">                </span><br><span class="line">        <span class="keyword">if</span> len(symbols) != <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># only release signal when the lists are not empty</span></span><br><span class="line">            self.events.put(SignalEvent(time, symbols,</span><br><span class="line">                                        np.array(prices), np.array(quantities), </span><br><span class="line">                                        directions))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MovingAverage</span><span class="params">(BaseStrategy)</span>:</span></span><br><span class="line">    <span class="string">"""</span><br><span class="line">    Current price crosses long memory from below: BUY.</span><br><span class="line">    Current price crosses long memory from above: EXIT.</span><br><span class="line">    </span><br><span class="line">    Rebalance on a weekly basis.</span><br><span class="line">    No short selling allowed.</span><br><span class="line">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(</span><br><span class="line">    self, data_handler, position_handler, events)</span>:</span></span><br><span class="line">        <span class="string">"""</span><br><span class="line">        @Parameters:</span><br><span class="line">        evnets - Events queue shared with backtest.</span><br><span class="line">               implement this funcionality.</span><br><span class="line">        initialized - Since the starting portfolio is 50-50 stock-cash, this </span><br><span class="line">                      helps to specify the different allocation strategy.</span><br><span class="line">        """</span></span><br><span class="line">        self.id = <span class="string">'Moving Average (MA)'</span></span><br><span class="line">        self.data_handler = data_handler</span><br><span class="line">        self.position_handler = position_handler</span><br><span class="line">        self.symbols = data_handler.symbols</span><br><span class="line">        self.events = events</span><br><span class="line">        self.r = data_handler.r</span><br><span class="line">        self.T = data_handler.T</span><br><span class="line">        self.bought = dict((s, <span class="string">'OUT'</span>) <span class="keyword">for</span> s <span class="keyword">in</span> self.symbols)</span><br><span class="line">                </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate_signals</span><span class="params">(self, event)</span>:</span></span><br><span class="line">        <span class="string">"""</span><br><span class="line">        Implement the strategy.</span><br><span class="line">        """</span></span><br><span class="line">        <span class="keyword">assert</span> event.type == <span class="string">'MARKET'</span></span><br><span class="line">        symbols = []</span><br><span class="line">        prices = []</span><br><span class="line">        quantities = []</span><br><span class="line">        directions = []</span><br><span class="line">        time = self.data_handler.get_latest_bar(self.symbols[<span class="number">0</span>])[<span class="number">0</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> symbol <span class="keyword">in</span> self.symbols:</span><br><span class="line">            price = self.data_handler.get_latest_bar_value(symbol, <span class="string">'Adj Close'</span>)</span><br><span class="line">            quantity = <span class="number">0.</span></span><br><span class="line">            direction = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">##################################</span></span><br><span class="line">            <span class="comment"># Test whether need to rebalance #</span></span><br><span class="line">            <span class="comment">##################################</span></span><br><span class="line">            long_memory = np.mean(self.data_handler.get_recent_bars_values(</span><br><span class="line">                symbol, <span class="string">'Adj Close'</span>, <span class="number">30</span>))</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> self.bought[symbol] == <span class="string">'OUT'</span>:</span><br><span class="line">                <span class="keyword">if</span> price &gt; long_memory:</span><br><span class="line">                    direction = <span class="string">'BUY'</span></span><br><span class="line">                    quantity = round(</span><br><span class="line">                        self.position_handler.current_position[<span class="string">'cash'</span>] / price, <span class="number">4</span>)</span><br><span class="line">                    self.bought[symbol] = <span class="string">'LONG'</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                    </span><br><span class="line">            <span class="keyword">elif</span> self.bought[symbol] == <span class="string">'LONG'</span>:</span><br><span class="line">                <span class="keyword">if</span> price &lt; long_memory:</span><br><span class="line">                    direction = <span class="string">'SELL'</span></span><br><span class="line">                    quantity = abs(self.position_handler.current_position[symbol][<span class="number">0</span>])</span><br><span class="line">                    self.bought[symbol] = <span class="string">'OUT'</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> quantity != <span class="number">0.</span>:</span><br><span class="line">                symbols.append(symbol)</span><br><span class="line">                prices.append(price)</span><br><span class="line">                quantities.append(quantity)</span><br><span class="line">                directions.append(direction)  </span><br><span class="line">                </span><br><span class="line">        <span class="keyword">if</span> len(symbols) != <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># only release signal when the lists are not empty</span></span><br><span class="line">            self.events.put(SignalEvent(time, symbols,</span><br><span class="line">                                        np.array(prices), np.array(quantities), </span><br><span class="line">                                        directions))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MovingAverage2</span><span class="params">(BaseStrategy)</span>:</span></span><br><span class="line">    <span class="string">"""</span><br><span class="line">    10 week price crosses 30 week from below: BUY.</span><br><span class="line">    10 week price crosses 30 week from above: EXIT.</span><br><span class="line">    </span><br><span class="line">    Rebalance on a weekly basis.</span><br><span class="line">    No short selling allowed.</span><br><span class="line">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(</span><br><span class="line">    self, data_handler, position_handler, events)</span>:</span></span><br><span class="line">        <span class="string">"""</span><br><span class="line">        @Parameters:</span><br><span class="line">        evnets - Events queue shared with backtest.</span><br><span class="line">               implement this funcionality.</span><br><span class="line">        initialized - Since the starting portfolio is 50-50 stock-cash, this </span><br><span class="line">                      helps to specify the different allocation strategy.</span><br><span class="line">        """</span></span><br><span class="line">        self.id = <span class="string">'Moving Average (MA2)'</span></span><br><span class="line">        self.data_handler = data_handler</span><br><span class="line">        self.position_handler = position_handler</span><br><span class="line">        self.symbols = data_handler.symbols</span><br><span class="line">        self.events = events</span><br><span class="line">        self.r = data_handler.r</span><br><span class="line">        self.T = data_handler.T</span><br><span class="line">        self.bought = dict((s, <span class="string">'OUT'</span>) <span class="keyword">for</span> s <span class="keyword">in</span> self.symbols)</span><br><span class="line">                </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate_signals</span><span class="params">(self, event)</span>:</span></span><br><span class="line">        <span class="string">"""</span><br><span class="line">        Implement the strategy.</span><br><span class="line">        """</span></span><br><span class="line">        <span class="keyword">assert</span> event.type == <span class="string">'MARKET'</span></span><br><span class="line">        symbols = []</span><br><span class="line">        prices = []</span><br><span class="line">        quantities = []</span><br><span class="line">        directions = []</span><br><span class="line">        time = self.data_handler.get_latest_bar(self.symbols[<span class="number">0</span>])[<span class="number">0</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> symbol <span class="keyword">in</span> self.symbols:</span><br><span class="line">            price = self.data_handler.get_latest_bar_value(symbol, <span class="string">'Adj Close'</span>)</span><br><span class="line">            quantity = <span class="number">0.</span></span><br><span class="line">            direction = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">##################################</span></span><br><span class="line">            <span class="comment"># Test whether need to rebalance #</span></span><br><span class="line">            <span class="comment">##################################</span></span><br><span class="line">            long_memory = np.mean(self.data_handler.get_recent_bars_values(</span><br><span class="line">                symbol, <span class="string">'Adj Close'</span>, <span class="number">30</span>))</span><br><span class="line">            short_memory = np.mean(self.data_handler.get_recent_bars_values(</span><br><span class="line">                symbol, <span class="string">'Adj Close'</span>, <span class="number">10</span>))   </span><br><span class="line">                </span><br><span class="line">            <span class="keyword">if</span> self.bought[symbol] == <span class="string">'OUT'</span>:</span><br><span class="line">                <span class="keyword">if</span> short_memory &gt; long_memory:</span><br><span class="line">                    direction = <span class="string">'BUY'</span></span><br><span class="line">                    quantity = round(</span><br><span class="line">                        self.position_handler.current_position[<span class="string">'cash'</span>] / price, <span class="number">4</span>) </span><br><span class="line">                    self.bought[symbol] = <span class="string">'LONG'</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                    </span><br><span class="line">            <span class="keyword">elif</span> self.bought[symbol] == <span class="string">'LONG'</span>:</span><br><span class="line">                <span class="keyword">if</span> short_memory &lt; long_memory:</span><br><span class="line">                    direction = <span class="string">'SELL'</span></span><br><span class="line">                    quantity = abs(self.position_handler.current_position[symbol][<span class="number">0</span>])</span><br><span class="line">                    self.bought[symbol] = <span class="string">'OUT'</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> quantity != <span class="number">0.</span>:</span><br><span class="line">                symbols.append(symbol)</span><br><span class="line">                prices.append(price)</span><br><span class="line">                quantities.append(quantity)</span><br><span class="line">                directions.append(direction)  </span><br><span class="line">                </span><br><span class="line">        <span class="keyword">if</span> len(symbols) != <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># only release signal when the lists are not empty</span></span><br><span class="line">            self.events.put(SignalEvent(time, symbols,</span><br><span class="line">                                        np.array(prices), np.array(quantities), </span><br><span class="line">                                        directions))</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer>
      
        
        
  
  <div class="tags">
    <a href="/tags/Research/">Research</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">Comments</h1>

  
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
  
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:blog.yibingxie.com">
  </form>
</div>

  

  
<div class="widget tag">
  <h3 class="title">Tags</h3>
  <ul class="entry">
  
    <li><a href="/tags/Algorithms/">Algorithms</a><small>2</small></li>
  
    <li><a href="/tags/Econometrics/">Econometrics</a><small>3</small></li>
  
    <li><a href="/tags/Notes/">Notes</a><small>1</small></li>
  
    <li><a href="/tags/Research/">Research</a><small>1</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2016 Yibing Xie
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'yibingxie';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


<script type="text/x-mathjax-config"> 
MathJax.Hub.Config({ 
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]} 
}); 
</script>
<script type="text/javascript"
   src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body>
</html>
